-- PROXIMITY PROMPT TOOL GRABBER + ESP v7.3 (Global Range Bypass)
-- FUNCTION: Triggers ALL filtered Tool-Giver ProximityPrompts regardless of distance.

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
if not Player then return end
local PlayerGui = Player:WaitForChild("PlayerGui")
local Character = Player.Character or Player.CharacterAdded:Wait()

local ProximityPrompts = {}
local Enabled = true -- Controls the Global Auto-Trigger

-- === ESP AND GUI SETUP (Unchanged for control) ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PromptESP"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0, 300, 0, 30)
StatusLabel.Position = UDim2.new(0.5, -150, 0, 50)
StatusLabel.BackgroundTransparency = 0.8
StatusLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
StatusLabel.Font = Enum.Font.SourceSansBold
StatusLabel.TextSize = 18
StatusLabel.Text = "ProximityPrompt ESP/Grabber: ACTIVE"
StatusLabel.Parent = ScreenGui

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 100, 0, 30)
ToggleButton.Position = UDim2.new(0.5, 160, 0, 50)
ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextSize = 14
ToggleButton.Text = "TOGGLE GLOBAL GRAB"
ToggleButton.Parent = ScreenGui

ToggleButton.MouseButton1Click:Connect(function()
    Enabled = not Enabled
    if Enabled then
        ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        ToggleButton.Text = "TOGGLE GLOBAL GRAB"
    else
        ToggleButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
        ToggleButton.Text = "DISABLED"
    end
end)

-- === CORE FUNCTIONS ===

-- 1. PROMPT SCANNER (Tool-Giver Filter - Unchanged from v7.2)
local function scanPrompts()
    for _, data in ipairs(ProximityPrompts) do
        if data.ESPLabel then data.ESPLabel:Destroy() end
        if data.Line then data.Line:Destroy() end
    end
    ProximityPrompts = {}
    
    local toolKeywords = {"get", "take", "grab", "equip", "tool", "item", "spawn", "pick up"}
    
    for _, descendant in ipairs(Workspace:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then
            local prompt = descendant
            local toolName = "Unknown Item (Filtered)"
            local parent = prompt.Parent
            local isToolGiver = false
            
            local toolCandidate = parent:FindFirstChildOfClass("Tool")
            if toolCandidate then
                toolName = toolCandidate.Name
                isToolGiver = true
            else
                local promptText = prompt.ObjectText:lower()
                local parentName = parent.Name:lower()
                local hasToolName = false
                local guessedName = ""
                
                local nameAttr = parent:GetAttribute("ToolName") or parent:GetAttribute("ItemName") or parent:GetAttribute("Tool")
                if nameAttr and type(nameAttr) == "string" and nameAttr ~= "" then
                    guessedName = nameAttr
                    hasToolName = true
                else
                     for _, child in ipairs(parent:GetChildren()) do
                        if child:IsA("BasePart") or child:IsA("MeshPart") then
                             if not child.Name:match("Handle") and not child.Name:match("Part") and not child.Name:match("Base") then
                                 guessedName = child.Name
                                 hasToolName = true
                                 break
                             end
                        end
                    end
                end

                if hasToolName then
                    toolName = guessedName
                end

                local isKeywordMatch = false
                for _, keyword in ipairs(toolKeywords) do
                    if promptText:find(keyword) or parentName:find(keyword) then
                        isKeywordMatch = true
                        break
                    end
                end
                
                if not (promptText:find("sleep") or promptText:find("craft") or promptText:find("store") or promptText:find("ui") or parentName:find("sleep") or parentName:find("craft") or parentName:find("store")) then
                    if isKeywordMatch and hasToolName then
                        isToolGiver = true
                    end
                end
            end
            
            if isToolGiver then
                 table.insert(ProximityPrompts, {
                    Prompt = prompt,
                    ToolName = toolName, 
                    ESPLabel = nil,
                    Line = nil
                })
            end
        end
    end
    
    for _, data in ipairs(ProximityPrompts) do
        createESP(data)
    end
    
    StatusLabel.Text = "Prompts Found: " .. #ProximityPrompts .. " | Auto Grab: " .. (Enabled and "ON" or "OFF")
end

-- 2. ESP/VISUALS (Unchanged)
local function createESP(promptData)
    local prompt = promptData.Prompt
    local parent = prompt.Parent
    
    local adornee = parent:IsA("BasePart") and parent or (parent.PrimaryPart or parent)
    if not adornee:IsA("BasePart") then return end
    
    local Billboard = Instance.new("BillboardGui")
    Billboard.Size = UDim2.new(0, 200, 0, 40)
    Billboard.AlwaysOnTop = true
    Billboard.ExtentsOffset = Vector3.new(0, 5, 0)
    Billboard.Adornee = adornee
    Billboard.Parent = PlayerGui

    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, 0, 1, 0)
    Label.BackgroundTransparency = 0.5 
    Label.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Label.TextColor3 = Color3.fromRGB(0, 255, 255) 
    Label.Font = Enum.Font.SourceSansBold
    Label.TextSize = 16
    Label.Text = string.format("[GLOBAL GRAB] ITEM: %s", promptData.ToolName) -- Updated text
    Label.Parent = Billboard
    
    local Line = Instance.new("Part")
    Line.BrickColor = BrickColor.new("Bright yellow")
    Line.Material = Enum.Material.ForceField
    Line.Anchored = true
    Line.CanCollide = false
    Line.Size = Vector3.new(0.1, 0.1, 0.1)
    Line.Parent = Workspace
    Line.Transparency = 0.5

    promptData.ESPLabel = Billboard
    promptData.Line = Line
end

local function updateESP()
    local Camera = Workspace.CurrentCamera
    if not Camera or not Character or not Character:FindFirstChild("HumanoidRootPart") then return end
    local HRP = Character.HumanoidRootPart
    
    for _, data in ipairs(ProximityPrompts) do
        local prompt = data.Prompt
        local line = data.Line
        
        if prompt.Parent and prompt.Parent.PrimaryPart and data.ESPLabel then
            local targetPos = prompt.Parent.PrimaryPart.Position
            local dist = (targetPos - HRP.Position).Magnitude
            
            if line then
                local center = (HRP.Position + targetPos) / 2
                local magnitude = (HRP.Position - targetPos).Magnitude
                
                line.CFrame = CFrame.lookAt(center, targetPos) * CFrame.new(0, 0, -magnitude / 2)
                line.Size = Vector3.new(0.1, 0.1, magnitude)
                line.Transparency = math.min(0.5, dist / 150)
            end
        else
            if data.ESPLabel then data.ESPLabel:Destroy() end
            if data.Line then data.Line:Destroy() end
        end
    end
end

-- 3. AUTO-GRAB/TRIGGER (CRITICAL CHANGE: Range Bypass)
local function globalTrigger()
    if not Enabled then return end
    
    local grabbedCount = 0
    
    for _, data in ipairs(ProximityPrompts) do
        local prompt = data.Prompt
        
        -- Check if the prompt is still valid and enabled
        if prompt.Parent and prompt.Enabled and prompt.Triggered:Wait(0.05) == nil then
            
            -- *** BYPASS RANGE CHECK ***
            -- Directly fire the event without distance checking
            prompt:InputHoldEnd() 
            grabbedCount = grabbedCount + 1
            
            StarterGui:SetCore("SendNotification", {
                Title="GLOBAL GRAB", 
                Text="Grabbed: " .. data.ToolName, 
                Duration=1.5
            })
            
            -- Small wait to avoid overwhelming the server
            task.wait(0.01)
        end
    end

    if grabbedCount > 0 then
        StatusLabel.Text = "GRABBED " .. grabbedCount .. " ITEMS GLOBALLY!"
    end
end

-- === EXECUTION LOOP ===
task.spawn(function()
    while task.wait(5) do
        scanPrompts() 
    end
end)

RunService.Heartbeat:Connect(function()
    updateESP()
    -- Global trigger runs every frame when enabled, grabbing everything instantly
    if Enabled then
        globalTrigger()
    end
end)

StarterGui:SetCore("SendNotification", {
    Title="PROMPT GRABBER v7.3", 
    Text="GLOBAL GRAB is ready. It will trigger all tool prompts regardless of distance.", 
    Duration=6
})
