-- SELDA RP AUTO LOOTBOX OPENER v2.0
-- BYPASSES WALLS/MODELS | Auto-TP + Trigger even if HIDDEN
-- Works: Behind walls, inside models, under ground

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local PlayerGui = Player:WaitForChild("PlayerGui")

task.wait(3)

-- === CONFIG ===
local SEARCH_KEYWORDS = {"lootbox", "chest", "loot", "treasure", "box", "crate", "vault", "safe"}
local TP_OFFSET = Vector3.new(0, 5, 0)  -- TP above the prompt to avoid clipping
local TRIGGER_DELAY = 0
local SCAN_INTERVAL = 1.5

-- === VARIABLES ===
local autoRunning = false
local connection = nil
local processedPrompts = {}  -- Anti-repeat

-- === FIND PROXIMITY PROMPTS (Even if HIDDEN) ===
local function findHiddenPrompts()
    local prompts = {}
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            local parent = obj.Parent
            if not parent then continue end
            
            local name = parent.Name:lower()
            local modelName = (parent.Parent and parent.Parent.Name:lower()) or ""
            
            for _, keyword in pairs(SEARCH_KEYWORDS) do
                if string.find(name, keyword) or string.find(modelName, keyword) then
                    table.insert(prompts, obj)
                    break
                end
            end
        end
    end
    return prompts
end

-- === SAFE TP (Bypass Walls) ===
local function safeTeleport(prompt)
    local root = prompt.Parent
    if not root then return false end
    
    local targetPos = root.Position + TP_OFFSET
    
    -- Raycast to find safe spot above
    local ray = Ray.new(targetPos + Vector3.new(0, 50, 0), Vector3.new(0, -100, 0))
    local hit, pos = Workspace:FindPartOnRayWithIgnoreList(ray, {Character})
    
    if hit then
        targetPos = pos + Vector3.new(0, 3, 0)
    end
    
    HumanoidRootPart.CFrame = CFrame.new(targetPos)
    task.wait(0.3)
    return true
end

-- === TRIGGER PROMPT (Even if NOT VISIBLE) ===
local function triggerPrompt(prompt)
    if not prompt or not prompt.Parent then return false end
    
    -- Method 1: InputHold (Most Reliable)
    pcall(function()
        prompt:InputHoldBegin()
        task.wait(0.1)
        prompt:InputHoldEnd()
    end)
    
    -- Method 2: Direct Trigger (Bypass Visibility)
    pcall(function()
        prompt.Triggered:Fire(prompt.Parent)
    end)
    
    -- Method 3: Fire ProximityPromptService (Advanced)
    local ppService = game:GetService("ProximityPromptService")
    pcall(function()
        ppService:Trigger(prompt)
    end)
    
    return true
end

-- === MAIN LOOP ===
local function startAutoLoot()
    if autoRunning then return end
    autoRunning = true
    processedPrompts = {}
    
    connection = RunService.Heartbeat:Connect(function()
        if not autoRunning then return end
        
        local prompts = findHiddenPrompts()
        if #prompts == 0 then return end
        
        for _, prompt in pairs(prompts) do
            if not autoRunning then break end
            
            local promptId = prompt:GetFullName()
            if processedPrompts[promptId] then continue end
            
            -- Teleport safely
            if safeTeleport(prompt) then
                -- Trigger even if hidden
                if triggerPrompt(prompt) then
                    processedPrompts[promptId] = true
                    task.wait(TRIGGER_DELAY)
                end
            end
            
            task.wait(0.1)
        end
    end)
    
    -- Refresh processed list every 30s
    spawn(function()
        while autoRunning do
            task.wait(30)
            processedPrompts = {}
        end
    end)
end

local function stopAutoLoot()
    autoRunning = false
    if connection then
        connection:Disconnect()
        connection = nil
    end
end

-- === UI (ON/OFF Toggle) ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoLootV2"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 280, 0, 140)
Frame.Position = UDim2.new(0, 15, 0.5, -70)
Frame.BackgroundColor3 = Color3.fromRGB(22, 22, 33)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 14)
Corner.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
Title.Text = "AUTO LOOTBOX v2"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 17
Title.Parent = Frame

local Corner2 = Instance.new("UICorner")
Corner2.CornerRadius = UDim.new(0, 14)
Corner2.Parent = Title

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, -20, 0, 25)
Status.Position = UDim2.new(0, 10, 0, 45)
Status.BackgroundTransparency = 1
Status.Text = "Status: OFF"
Status.TextColor3 = Color3.fromRGB(255, 100, 100)
Status.Font = Enum.Font.Gotham
Status.TextSize = 13
Status.Parent = Frame

local Toggle = Instance.new("TextButton")
Toggle.Size = UDim2.new(0.8, 0, 0, 45)
Toggle.Position = UDim2.new(0.1, 0, 0.6, 0)
Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
Toggle.Text = "TURN ON"
Toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
Toggle.Font = Enum.Font.GothamBold
Toggle.TextSize = 18
Toggle.Parent = Frame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 12)
ToggleCorner.Parent = Toggle

Toggle.MouseButton1Click:Connect(function()
    if autoRunning then
        stopAutoLoot()
        Toggle.Text = "TURN ON"
        Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        Status.Text = "Status: OFF"
        Status.TextColor3 = Color3.fromRGB(255, 100, 100)
        StarterGui:SetCore("SendNotification", {Title="Auto Loot", Text="Stopped", Duration=2})
    else
        startAutoLoot()
        Toggle.Text = "TURN OFF"
        Toggle.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        Status.Text = "Status: RUNNING"
        Status.TextColor3 = Color3.fromRGB(100, 255, 100)
        StarterGui:SetCore("SendNotification", {Title="Auto Loot v2", Text="Bypassing walls & opening hidden lootboxes!", Duration=4})
    end
end)

-- === RESPAWN HANDLER ===
Player.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
end)

-- === NOTIFICATION ===
StarterGui:SetCore("SendNotification", {
    Title = "SELDA RP Auto Loot v2";
    Text = "BYPASSES WALLS & MODELS! Toggle ON to start.";
    Duration = 6;
})
