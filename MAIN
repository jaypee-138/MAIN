-- SELDA RP AUTO LOOTBOX OPENER v3.0
-- FIXED: Triggers ALL prompts | Moves to next | No stuck
-- Works: Behind walls, under models, multiple lootboxes

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local StarterGui = game:GetService("StarterGui")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")
local PlayerGui = Player:WaitForChild("PlayerGui")

task.wait(3)

-- === CONFIG ===
local KEYWORDS = {"lootbox", "chest", "loot", "treasure", "box", "crate", "vault", "safe"}
local TP_HEIGHT = 6
local TRIGGER_HOLD_TIME = 1
local MOVE_DELAY = 1  -- Time before moving to next
local SCAN_EVERY = 2   -- Refresh prompts every X sec

-- === VARIABLES ===
local autoRunning = false
local connection = nil
local openedPrompts = {}  -- Track opened ones
local currentTarget = nil

-- === FIND PROMPTS (Even Hidden) ===
local function getAllPrompts()
    local prompts = {}
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") and not openedPrompts[obj] then
            local parent = obj.Parent
            if not parent then continue end
            local name = parent.Name:lower()
            local model = parent.Parent and parent.Parent.Name:lower() or ""
            
            for _, kw in pairs(KEYWORDS) do
                if string.find(name, kw) or string.find(model, kw) then
                    table.insert(prompts, obj)
                    break
                end
            end
        end
    end
    return prompts
end

-- === SAFE TELEPORT ABOVE PROMPT ===
local function teleportToPrompt(prompt)
    local root = prompt.Parent
    if not root then return false end
    
    local targetPos = root.Position + Vector3.new(0, TP_HEIGHT, 0)
    
    -- Raycast down to find ground
    local ray = Ray.new(targetPos + Vector3.new(0, 50, 0), Vector3.new(0, -100, 0))
    local hit, pos = Workspace:FindPartOnRayWithIgnoreList(ray, {Character})
    
    if hit then
        targetPos = pos + Vector3.new(0, 4, 0)
    end
    
    HumanoidRootPart.CFrame = CFrame.new(targetPos)
    task.wait(0.4)  -- Wait for TP
    return true
end

-- === TRIGGER PROMPT (3 METHODS + RETRY) ===
local function triggerPrompt(prompt)
    if not prompt or not prompt.Parent then return false end
    
    local success = false
    
    -- Method 1: InputHold (Most games)
    pcall(function()
        prompt:InputHoldBegin()
        task.wait(TRIGGER_HOLD_TIME)
        prompt:InputHoldEnd()
        success = true
    end)
    
    -- Method 2: ProximityPromptService
    if not success then
        pcall(function()
            ProximityPromptService:Trigger(prompt)
            success = true
        end)
    end
    
    -- Method 3: Fire Triggered Event
    if not success then
        pcall(function()
            prompt.Triggered:Fire()
            success = true
        end)
    end
    
    return success
end

-- === MAIN AUTO LOOP (FIXED: Moves to Next) ===
local function startAutoLoot()
    if autoRunning then return end
    autoRunning = true
    openedPrompts = {}
    currentTarget = nil
    
    connection = RunService.Heartbeat:Connect(function()
        if not autoRunning or not Character or not HumanoidRootPart then return end
        
        local prompts = getAllPrompts()
        if #prompts == 0 then
            currentTarget = nil
            return
        end
        
        -- Get closest unopened prompt
        table.sort(prompts, function(a, b)
            local distA = (HumanoidRootPart.Position - a.Parent.Position).Magnitude
            local distB = (HumanoidRootPart.Position - b.Parent.Position).Magnitude
            return distA < distB
        end)
        
        local target = prompts[1]
        if target == currentTarget then return end  -- Already processing
        
        currentTarget = target
        
        -- TP
        if teleportToPrompt(target) then
            -- Trigger
            if triggerPrompt(target) then
                openedPrompts[target] = true
                StarterGui:SetCore("SendNotification", {
                    Title = "Lootbox Opened!",
                    Text = "Got loot from: " .. (target.Parent.Name),
                    Duration = 2
                })
            end
        end
        
        task.wait(MOVE_DELAY)
        currentTarget = nil
    end)
    
    -- Refresh opened list every 30s
    spawn(function()
        while autoRunning do
            task.wait(30)
            local newList = {}
            for prompt, _ in pairs(openedPrompts) do
                if prompt and prompt.Parent then
                    newList[prompt] = true
                end
            end
            openedPrompts = newList
        end
    end)
end

local function stopAutoLoot()
    autoRunning = false
    if connection then connection:Disconnect() end
    connection = nil
    currentTarget = nil
end

-- === UI (Status + Toggle) ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoLootV3"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 300, 0, 160)
Frame.Position = UDim2.new(0, 15, 0.5, -80)
Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 16)

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 45)
Title.BackgroundColor3 = Color3.fromRGB(0, 160, 255)
Title.Text = "AUTO LOOTBOX v3"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = Frame
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 16)

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, -20, 0, 30)
Status.Position = UDim2.new(0, 10, 0, 50)
Status.BackgroundTransparency = 1
Status.Text = "Status: OFF"
Status.TextColor3 = Color3.fromRGB(255, 100, 100)
Status.Font = Enum.Font.Gotham
Status.TextSize = 14
Status.Parent = Frame

local Count = Instance.new("TextLabel")
Count.Size = UDim2.new(1, -20, 0, 20)
Count.Position = UDim2.new(0, 10, 0, 75)
Count.BackgroundTransparency = 1
Count.Text = "Opened: 0"
Count.TextColor3 = Color3.fromRGB(100, 255, 100)
Count.Font = Enum.Font.Gotham
Count.TextSize = 12
Count.Parent = Frame

local Toggle = Instance.new("TextButton")
Toggle.Size = UDim2.new(0.8, 0, 0, 50)
Toggle.Position = UDim2.new(0.1, 0, 0.55, 0)
Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
Toggle.Text = "TURN ON"
Toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
Toggle.Font = Enum.Font.GothamBold
Toggle.TextSize = 18
Toggle.Parent = Frame
Instance.new("UICorner", Toggle).CornerRadius = UDim.new(0, 12)

-- Update counter
spawn(function()
    local openedCount = 0
    while task.wait(1) do
        if autoRunning then
            openedCount = 0
            for _ in pairs(openedPrompts) do openedCount += 1 end
            Count.Text = "Opened: " .. openedCount
        end
    end
end)

Toggle.MouseButton1Click:Connect(function()
    if autoRunning then
        stopAutoLoot()
        Toggle.Text = "TURN ON"
        Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        Status.Text = "Status: OFF"
        Status.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        startAutoLoot()
        Toggle.Text = "TURN OFF"
        Toggle.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        Status.Text = "Status: SCANNING..."
        Status.TextColor3 = Color3.fromRGB(100, 255, 100)
    end
end)

-- === RESPAWN ===
Player.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
    Humanoid = char:WaitForChild("Humanoid")
    task.wait(2)
    if autoRunning then startAutoLoot() end
end)

-- === NOTIF ===
StarterGui:SetCore("SendNotification", {
    Title = "SELDA RP Auto Loot v3";
    Text = "FIXED: Triggers ALL lootboxes! Turn ON to start.";
    Duration = 6;
})
