-- SELDA AUTOLOOT v6.0
-- ZERO LAG | INSTANT TRIGGER | FULL REGEN SUPPORT
-- Name: SELDA AUTOLOOT | 100% Working Forever!

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local StarterGui = game:GetService("StarterGui")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local PlayerGui = Player:WaitForChild("PlayerGui")

task.wait(3)

-- === CONFIG (SUPER FAST) ===
local KEYWORDS = {"lootbox", "chest", "loot", "treasure", "box", "crate", "vault", "safe", "reward"}
local MAX_DISTANCE = 400
local TP_HEIGHT = 5
local INSTANT_HOLD = 0.01  -- Parang instant press E
local WAIT_AFTER_OPEN = 0.6  -- Enough for loot animation
local SCAN_EVERY = 3  -- Scan only every 3 seconds = ZERO LAG

-- === VARIABLES (OPTIMIZED) ===
local autoRunning = false
local lastScanTime = 0
local allPrompts = {}  -- Live list of ALL prompts (including new ones)
local openedPrompts = {}  -- Track by object (auto clears if destroyed)
local openedCount = 0
local connection = nil

-- === AUTO UPDATE PROMPT LIST (REGEN SUPPORT) ===
local function updatePromptList()
    local newList = {}
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            local parent = obj.Parent
            if parent then
                local name = parent.Name:lower()
                local model = (parent.Parent and parent.Parent.Name:lower()) or ""
                for _, kw in pairs(KEYWORDS) do
                    if string.find(name, kw) or string.find(model, kw) then
                        newList[obj] = {Part = parent, Opened = openedPrompts[obj] or false}
                        break
                    end
                end
            end
        end
    end
    allPrompts = newList
end

-- === SAFE TP (NO ROOF) ===
local function safeTP(part)
    local pos = part.Position
    local ray = workspace:Raycast(pos + Vector3.new(0, 50, 0), Vector3.new(0, -100, 0))
    if ray then
        local y = math.min(ray.Position.Y + TP_HEIGHT, pos.Y + 8)
        HumanoidRootPart.CFrame = CFrame.new(pos.X, y, pos.Z)
        task.wait(0.3)
        return true
    end
    return false
end

-- === INSTANT TRIGGER (LIKE PRESS E) ===
local function instantTrigger(prompt)
    local success = false
    pcall(function()
        prompt:InputHoldBegin()
        task.wait(INSTANT_HOLD)
        prompt:InputHoldEnd()
        success = true
    end)
    if not success then
        pcall(function() ProximityPromptService:Trigger(prompt) end)
    end
    return success
end

-- === MAIN LOOP (LAG-FREE) ===
local function startAutoLoot()
    if autoRunning then return end
    autoRunning = true
    openedCount = 0
    
    connection = RunService.Heartbeat:Connect(function()
        if not autoRunning then return end
        
        local now = tick()
        if now - lastScanTime >= SCAN_EVERY then
            updatePromptList()
            lastScanTime = now
        end
        
        -- Find closest unopened
        local closest = nil
        local closestDist = MAX_DISTANCE
        
        for prompt, data in pairs(allPrompts) do
            if not data.Opened then
                local dist = (HumanoidRootPart.Position - data.Part.Position).Magnitude
                if dist < closestDist then
                    closest = prompt
                    closestDist = dist
                end
            end
        end
        
        if not closest then return end
        
        local part = allPrompts[closest].Part
        
        -- TP if far
        if closestDist > 12 then
            safeTP(part)
        end
        
        -- Instant trigger
        if instantTrigger(closest) then
            allPrompts[closest].Opened = true
            openedPrompts[closest] = true
            openedCount += 1
            StarterGui:SetCore("SendNotification", {
                Title = "Loot Get!",
                Text = part.Name .. " | Total: " .. openedCount,
                Duration = 1.5
            })
            task.wait(WAIT_AFTER_OPEN)
        end
    end)
end

local function stopAutoLoot()
    autoRunning = false
    if connection then connection:Disconnect() end
    connection = nil
end

-- === UI: SELDA AUTOLOOT ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SeldaAutoloot"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 340, 0, 180)
Frame.Position = UDim2.new(0, 15, 0.5, -90)
Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 18)

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 50)
Title.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
Title.Text = "SELDA AUTOLOOT v6"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 20
Title.Parent = Frame
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 18)

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, -20, 0, 30)
Status.Position = UDim2.new(0, 10, 0, 55)
Status.BackgroundTransparency = 1
Status.Text = "Status: OFF"
Status.TextColor3 = Color3.fromRGB(255, 80, 80)
Status.Font = Enum.Font.GothamBold
Status.TextSize = 15
Status.Parent = Frame

local Counter = Instance.new("TextLabel")
Counter.Size = UDim2.new(1, -20, 0, 25)
Counter.Position = UDim2.new(0, 10, 0, 85)
Counter.BackgroundTransparency = 1
Counter.Text = "Looted: 0"
Counter.TextColor3 = Color3.fromRGB(100, 255, 100)
Counter.Font = Enum.Font.GothamBold
Counter.TextSize = 14
Counter.Parent = Frame

local Toggle = Instance.new("TextButton")
Toggle.Size = UDim2.new(0.85, 0, 0, 55)
Toggle.Position = UDim2.new(0.075, 0, 0.58, 0)
Toggle.BackgroundColor3 = Color3.fromRGB(220, 20, 20)
Toggle.Text = "TURN ON"
Toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
Toggle.Font = Enum.Font.GothamBold
Toggle.TextSize = 20
Toggle.Parent = Frame
Instance.new("UICorner", Toggle).CornerRadius = UDim.new(0, 14)

-- Live Counter
spawn(function()
    while task.wait(0.5) do
        Counter.Text = "Looted: " .. openedCount
    end
end)

Toggle.MouseButton1Click:Connect(function()
    if autoRunning then
        stopAutoLoot()
        Toggle.Text = "TURN ON"
        Toggle.BackgroundColor3 = Color3.fromRGB(220, 20, 20)
        Status.Text = "Status: OFF"
        Status.TextColor3 = Color3.fromRGB(255, 80, 80)
    else
        startAutoLoot()
        Toggle.Text = "TURN OFF"
        Toggle.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        Status.Text = "Status: AUTOLOOTING..."
        Status.TextColor3 = Color3.fromRGB(100, 255, 100)
    end
end)

-- === RESPAWN & REGEN SUPPORT ===
Player.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
    task.wait(2)
    allPrompts = {}
    openedPrompts = {}
    if autoRunning then startAutoLoot() end
end)

-- === CLEANUP OLD PROMPTS (REGEN FIX) ===
spawn(function()
    while task.wait(10) do
        for prompt, _ in pairs(openedPrompts) do
            if not prompt.Parent then
                openedPrompts[prompt] = nil
                allPrompts[prompt] = nil
            end
        end
    end
end)

-- === NOTIFICATION ===
StarterGui:SetCore("SendNotification", {
    Title = "SELDA AUTOLOOT v6";
    Text = "LAG-FREE + INSTANT + REGEN SUPPORT! Turn ON now!",
    Duration = 6;
})
