-- SELDA RP AUTO LOOTBOX OPENER v4.0
-- FINAL FIX: No TP to roof | Waits for trigger | Only valid prompts
-- 100% Stable | Mobile/PC | Delta/Arceus X

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local StarterGui = game:GetService("StarterGui")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")
local PlayerGui = Player:WaitForChild("PlayerGui")

task.wait(3)

-- === CONFIG ===
local KEYWORDS = {"lootbox", "chest", "loot", "treasure", "box", "crate", "vault", "safe"}
local MAX_DISTANCE = 1000
local TP_HEIGHT = 5
local HOLD_TIME = 2
local WAIT_AFTER_TRIGGER = 1  -- Wait for loot animation
local SCAN_INTERVAL = 2

-- === VARIABLES ===
local autoRunning = false
local connection = nil
local openedPrompts = {}
local currentTarget = nil
local openedCount = 0

-- === FIND VALID PROMPTS ===
local function getValidPrompts()
    local prompts = {}
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") and not openedPrompts[obj] then
            local parent = obj.Parent
            if not parent then continue end
            
            local name = parent.Name:lower()
            local model = (parent.Parent and parent.Parent.Name:lower()) or ""
            local validName = false
            
            for _, kw in pairs(KEYWORDS) do
                if string.find(name, kw) or string.find(model, kw) then
                    validName = true
                    break
                end
            end
            
            if validName then
                local dist = (HumanoidRootPart.Position - parent.Position).Magnitude
                if dist <= MAX_DISTANCE then
                    table.insert(prompts, {Prompt = obj, Part = parent, Distance = dist})
                end
            end
        end
    end
    
    -- Sort by closest
    table.sort(prompts, function(a, b) return a.Distance < b.Distance end)
    return prompts
end

-- === SAFE TP (NO ROOF!) ===
local function safeTP(part)
    local pos = part.Position
    local origin = pos + Vector3.new(0, 50, 0)
    local direction = Vector3.new(0, -100, 0)
    
    local raycast = workspace:Raycast(origin, direction, RaycastParams.new())
    if raycast then
        local groundY = raycast.Position.Y
        local targetY = groundY + TP_HEIGHT
        if targetY > pos.Y + 20 then targetY = pos.Y + TP_HEIGHT end  -- Prevent roof TP
        
        HumanoidRootPart.CFrame = CFrame.new(pos.X, targetY, pos.Z)
        task.wait(0.5)
        return true
    end
    return false
end

-- === TRIGGER & WAIT FOR SUCCESS ===
local function triggerAndWait(prompt)
    local success = false
    
    -- Try 3 methods
    for i = 1, 3 do
        if success then break end
        
        pcall(function()
            if i == 1 then
                prompt:InputHoldBegin()
                task.wait(HOLD_TIME)
                prompt:InputHoldEnd()
                success = true
            elseif i == 2 then
                ProximityPromptService:Trigger(prompt)
                success = true
            elseif i == 3 then
                prompt.Triggered:Fire()
                success = true
            end
        end)
        task.wait(0.1)
    end
    
    if success then
        task.wait(WAIT_AFTER_TRIGGER)  -- Wait for loot to appear
    end
    
    return success
end

-- === MAIN LOOP (NO BUGS) ===
local function startAutoLoot()
    if autoRunning then return end
    autoRunning = true
    openedCount = 0
    
    connection = RunService.Heartbeat:Connect(function()
        if not autoRunning then return end
        
        local targets = getValidPrompts()
        if #targets == 0 then
            currentTarget = nil
            return
        end
        
        local nextTarget = targets[1]
        if currentTarget == nextTarget.Prompt then return end
        
        currentTarget = nextTarget.Prompt
        
        -- TP only if far
        if nextTarget.Distance > 15 then
            if not safeTP(nextTarget.Part) then
                openedPrompts[currentTarget] = true
                currentTarget = nil
                return
            end
        end
        
        -- Trigger & wait
        if triggerAndWait(currentTarget) then
            openedPrompts[currentTarget] = true
            openedCount += 1
            StarterGui:SetCore("SendNotification", {
                Title = "Lootbox Opened!",
                Text = nextTarget.Part.Name .. " | Total: " .. openedCount,
                Duration = 2
            })
        else
            -- Retry once
            task.wait(0.5)
            if not triggerAndWait(currentTarget) then
                openedPrompts[currentTarget] = true  -- Mark as done to avoid loop
            end
        end
        
        currentTarget = nil
        task.wait(0.3)
    end)
end

local function stopAutoLoot()
    autoRunning = false
    if connection then connection:Disconnect() end
    connection = nil
    currentTarget = nil
end

-- === UI (WITH COUNTER) ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoLootV4"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 320, 0, 170)
Frame.Position = UDim2.new(0, 15, 0.5, -85)
Frame.BackgroundColor3 = Color3.fromRGB(18, 18, 28)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 16)

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 45)
Title.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
Title.Text = "AUTO LOOT v4"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.Parent = Frame
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 16)

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, -20, 0, 25)
Status.Position = UDim2.new(0, 10, 0, 50)
Status.BackgroundTransparency = 1
Status.Text = "Status: OFF"
Status.TextColor3 = Color3.fromRGB(255, 100, 100)
Status.Font = Enum.Font.Gotham
Status.TextSize = 14
Status.Parent = Frame

local Counter = Instance.new("TextLabel")
Counter.Size = UDim2.new(1, -20, 0, 25)
Counter.Position = UDim2.new(0, 10, 0, 75)
Counter.BackgroundTransparency = 1
Counter.Text = "Opened: 0"
Counter.TextColor3 = Color3.fromRGB(100, 255, 100)
Counter.Font = Enum.Font.GothamBold
Counter.TextSize = 14
Counter.Parent = Frame

local Toggle = Instance.new("TextButton")
Toggle.Size = UDim2.new(0.8, 0, 0, 50)
Toggle.Position = UDim2.new(0.1, 0, 0.58, 0)
Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
Toggle.Text = "TURN ON"
Toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
Toggle.Font = Enum.Font.GothamBold
Toggle.TextSize = 18
Toggle.Parent = Frame
Instance.new("UICorner", Toggle).CornerRadius = UDim.new(0, 12)

-- Update Counter
spawn(function()
    while task.wait(0.5) do
        Counter.Text = "Opened: " .. openedCount
    end
end)

Toggle.MouseButton1Click:Connect(function()
    if autoRunning then
        stopAutoLoot()
        Toggle.Text = "TURN ON"
        Toggle.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        Status.Text = "Status: OFF"
        Status.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        startAutoLoot()
        Toggle.Text = "TURN OFF"
        Toggle.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        Status.Text = "Status: RUNNING"
        Status.TextColor3 = Color3.fromRGB(100, 255, 100)
    end
end)

-- === RESPAWN ===
Player.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
    Humanoid = char:WaitForChild("Humanoid")
    task.wait(2)
    if autoRunning then startAutoLoot() end
end)

-- === NOTIF ===
StarterGui:SetCore("SendNotification", {
    Title = "SELDA RP Auto Loot v4";
    Text = "FINAL FIX: No roof TP | Waits for open | 100% stable!",
    Duration = 6;
})
